package com.trio.view.ctrl;

import java.util.List;

import org.zkoss.zk.ui.Component;
import org.zkoss.zkplus.databind.AnnotateDataBinder;
import org.zkoss.zul.Button;
import org.zkoss.zul.Combobox;
import org.zkoss.zul.Grid;
import org.zkoss.zul.ListModelList;
import org.zkoss.zul.Listbox;
import org.zkoss.zul.Messagebox;
import org.zkoss.zul.Radiogroup;
import org.zkoss.zul.Window;

import com.trio.base.TrioBasePage;
import com.trio.bean.bsc.DbaRolePrivs;
import com.trio.bean.h000.TrioH000Mstmenu;
import com.trio.bean.h000.TrioH000Mstroleaccess;
import com.trio.component.TrioPopup;
import com.trio.view.ctrl.renderer.RoleListRenderer;

public class RoleAccessCtrl extends TrioBasePage {

	private static final long serialVersionUID = 1L;
	private AnnotateDataBinder binder;
	private Listbox roleList;
	private Grid editRoleGrid;
	private Button createRole;
	private Button searchRole;
	private Button resetRole;
	private Combobox cbVparent;
	private Radiogroup radioStatus;
	
	private Button btLOVRole, btLOVMenu;
	
	private Window win;
	
	private TrioH000Mstroleaccess role;

	@Override
	public void doAfterCompose(Component comp) throws Exception {
		super.doAfterCompose(comp);
		binder = (AnnotateDataBinder) page.getAttribute("binder");
		role = new TrioH000Mstroleaccess();
		roleList.setModel(new ListModelList(
				getMasterFacade().getTrioH000MstroleaccessDao().findAll()));
		roleList.setItemRenderer(new RoleListRenderer());
	}
	
	private ListModelList getModel() {
		return (ListModelList) roleList.getModel();
	}
	
	public void onClick$resetRole() {
		reset();
	}
	
	public void reset(){
		roleList.clearSelection();
		roleList.setModel(new ListModelList(getMasterFacade().getTrioH000MstroleaccessDao().findAll()));
		role = new TrioH000Mstroleaccess();
		binder.loadComponent(editRoleGrid);
		radioStatus.setSelectedIndex(0);
	}
	
	public void onSelect$roleList() {
		role = (TrioH000Mstroleaccess) roleList.getSelectedItem().getValue();
		if (role.getVstatus().equalsIgnoreCase("A")){
			radioStatus.setSelectedIndex(0);
		}if (role.getVstatus().equalsIgnoreCase("X")){
			radioStatus.setSelectedIndex(1);
		}
		
		binder.loadComponent(editRoleGrid);
	}
	
	public void onClick$createRole() throws InterruptedException {
		
		String status = radioStatus.getSelectedItem().getValue();
		role.setVstatus(status);
		if (role.getVroleid() == null ||  role.getVmenuid() == null
				|| role.getVstatus() == null ) {
			Messagebox.show("Data belum lengkap");
			return;
		}
		
		List<DbaRolePrivs> listDba =  getMasterFacade().getDbaRolePrivsDao().getListByGrantedRole(role.getVroleid());
		if (listDba.size() < 1){
			Messagebox.show("Role ["+role.getVroleid()+"] tidak terdaftar"); 
			return;
		}
		
		TrioH000Mstmenu menu = getMasterFacade().getTrioH000MstmenuDao()
				.findByPrimaryKey(new TrioH000Mstmenu(role.getVmenuid()));
		if (menu == null){
			Messagebox.show("Menu ["+role.getVmenuid()+"] tidak terdaftar");
			return;
		}
		
		getMasterFacade().getTrioH000MstroleaccessDao().saveOrUpdate(role, getUserSession());
		getModel().add(role);
		
		reset();
	}
	
	public void onClick$searchRole() throws InterruptedException {
		TrioH000Mstroleaccess ra = new TrioH000Mstroleaccess();
		ra.setVroleid(role.getVroleid());
		ra.setVmenuid(role.getVmenuid());
		ra.setVstatus(radioStatus.getSelectedItem().getValue());
		
		roleList.setModel(new ListModelList(getMasterFacade().getTrioH000MstroleaccessDao().findByCriteria(ra)));
	}
	
	public void onClick$btLOVRole(){
		List<TrioH000Mstroleaccess> list = getMasterFacade().getTrioH000MstroleaccessDao().findAll();
		TrioPopup pop = new TrioPopup(list,new RoleListRenderer(),"400px","400px");
    	pop.setParent(win);
        pop.open(200,200);
	}
	
	public void onClick$btLOVMenu(){
		List<TrioH000Mstroleaccess> list = getMasterFacade().getTrioH000MstroleaccessDao().findAll();
		TrioPopup pop = new TrioPopup(list,new RoleListRenderer(),"400px","400px");
    	pop.setParent(win);
        pop.open(200,200);
	}

	public TrioH000Mstroleaccess getRole() {
		return role;
	}

	public void setRole(TrioH000Mstroleaccess role) {
		this.role = role;
	}
	
}
